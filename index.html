<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>DOA-Diagnostics Diagnose Verslag</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, textarea { display: block; margin-bottom: 10px; width: 100%; padding: 5px; }
        .fotoSectie { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        h3 { color: #42b0e5; }
        button { padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<h1 style="color: #42b0e5;">DOA-DIAGNOSTICS DIAGNOSE VERSLAG</h1>

<form id="diagnoseForm">
    <input type="text" name="opdrachtgever" placeholder="Opdrachtgever" required>
    <input type="date" name="datum" required>
    <input type="text" name="kenteken" placeholder="Kenteken" required>
    <input type="text" name="merk" placeholder="Merk / Type" required>
    <input type="number" name="bouwjaar" placeholder="Bouwjaar" required>
    <input type="text" name="vin" placeholder="VIN" required>
    <input type="text" name="motorcode" placeholder="Motorcode" required>
    <input type="number" name="kilometerstand" placeholder="Kilometerstand" required>
    <textarea name="klachtomschrijving" placeholder="Klachtomschrijving" required></textarea>
    <textarea name="diagnose" placeholder="Diagnose" required></textarea>
    <textarea name="verklaring" placeholder="Verklaring van opdrachtgever" required></textarea>

    <h3>Analyse van de permanente fouten</h3>
    <input type="file" accept="image/*" class="permanenteFoto">
    <textarea placeholder="Uitleg bij foto" class="permanenteUitleg"></textarea>

    <h3>Foto's</h3>
    <div id="fotoSecties">
        <div class="fotoSectie">
            <input type="file" accept="image/*">
            <textarea placeholder="Uitleg bij foto"></textarea>
        </div>
        <div class="fotoSectie">
            <input type="file" accept="image/*">
            <textarea placeholder="Uitleg bij foto"></textarea>
        </div>
    </div>

    <button type="button" id="voegSectieToe" style="background: green; color: white;">Voeg een nieuwe sectie toe</button>
    <button type="button" id="genereerPdf" style="background: blue; color: white;">Genereer PDF</button>
</form>

<script>
document.getElementById('voegSectieToe').addEventListener('click', () => {
    const container = document.getElementById('fotoSecties');
    for (let i = 0; i < 2; i++) {
        const div = document.createElement('div');
        div.className = 'fotoSectie';
        div.innerHTML = `
            <input type="file" accept="image/*">
            <textarea placeholder="Uitleg bij foto"></textarea>
        `;
        container.appendChild(div);
    }
});

// laad logo als base64
let logoBase64 = '';
fetch('IMG_1971.png')
.then(res => res.blob())
.then(blob => new Promise(r => {
    const reader = new FileReader();
    reader.onload = () => { logoBase64 = reader.result; r(); };
    reader.readAsDataURL(blob);
}));

document.getElementById('genereerPdf').addEventListener('click', async () => {
    const form = document.getElementById('diagnoseForm');
    const data = new FormData(form);

    let content = [];
    // logo
    if (logoBase64) {
        content.push({ image: logoBase64, width: 150, alignment: 'center', margin: [0, 0, 0, 10] });
    }
    // titel
    content.push({ text: 'DOA-DIAGNOSTICS DIAGNOSE VERSLAG', color: '#42b0e5', fontSize: 18, alignment: 'center', margin: [0, 0, 0, 10] });

    // velden
    const velden = [
        ['Opdrachtgever', data.get('opdrachtgever')],
        ['Datum', data.get('datum')],
        ['Kenteken', data.get('kenteken')],
        ['Merk / Type', data.get('merk')],
        ['Bouwjaar', data.get('bouwjaar')],
        ['VIN', data.get('vin')],
        ['Motorcode', data.get('motorcode')],
        ['Kilometerstand', data.get('kilometerstand')],
        ['Klachtomschrijving', data.get('klachtomschrijving')],
        ['Diagnose', data.get('diagnose')],
        ['Verklaring van opdrachtgever', data.get('verklaring')]
    ];
    velden.forEach(([label, value]) => {
        content.push({ text: `${label}: ${value}`, margin: [0, 0, 0, 5] });
    });

    // permanente fouten
    const permanenteFotoInput = document.querySelector('.permanenteFoto');
    const permanenteUitleg = document.querySelector('.permanenteUitleg').value;
    if (permanenteUitleg) {
        content.push({ text: permanenteUitleg, margin: [0, 5, 0, 5] });
    }
    if (permanenteFotoInput.files.length) {
        const imgData = await toDataURL(permanenteFotoInput.files[0]);
        content.push({ image: imgData, width: 300, margin: [0, 0, 0, 10] });
    }

    // dynamische foto secties
    const secties = document.querySelectorAll('#fotoSecties .fotoSectie');
    for (const sectie of secties) {
        const uitleg = sectie.querySelector('textarea').value;
        const fileInput = sectie.querySelector('input[type="file"]');
        if (uitleg) {
            content.push({ text: uitleg, margin: [0, 5, 0, 5] });
        }
        if (fileInput.files.length) {
            const imgData = await toDataURL(fileInput.files[0]);
            content.push({ image: imgData, width: 300, margin: [0, 0, 0, 10] });
        }
    }

    // PDF maken
    const docDefinition = {
        content,
        pageMargins: [40, 60, 40, 60]
    };

    // detecteer mobiel vs desktop
    if (/Mobi|Android/i.test(navigator.userAgent)) {
        pdfMake.createPdf(docDefinition).open();
    } else {
        pdfMake.createPdf(docDefinition).download('diagnose-verslag.pdf');
    }
});

function toDataURL(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });
}
</script>

</body>
</html>