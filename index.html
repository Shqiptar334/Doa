<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>DOA Diagnoseverslag</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f4f4;
    }
    h1 {
      font-size: 22px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    .photo-section {
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
    }
    .photo-section img {
      display: block;
      margin-top: 10px;
      max-width: 100%;
      height: auto;
    }
    #add-section, #generate {
      margin-top: 20px;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
      color: white;
    }
    #add-section {
      background-color: #5cb85c;
    }
    #generate {
      background-color: #0275d8;
    }
    .btn-add-photo {
      background: #337ab7;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>

<h1>DOA Diagnoseverslag</h1>

<label>Opdrachtgever:</label>
<input type="text" id="klant">

<label>Datum:</label>
<input type="date" id="datum">

<label>Kenteken:</label>
<input type="text" id="kenteken">

<label>Merk / Type:</label>
<input type="text" id="merk">

<label>VIN:</label>
<input type="text" id="vin">

<label>Kilometerstand:</label>
<input type="text" id="kmstand">

<label>Klachtomschrijving:</label>
<textarea id="klacht" rows="4"></textarea>

<label>Diagnose:</label>
<textarea id="diagnose" rows="5"></textarea>

<label>Verklaring van opdrachtgever:</label>
<textarea id="fouten" rows="5"></textarea>

<div class="photo-section">
  <label>Analyse van de permanent fouten</label>
  <button class="btn-add-photo" onclick="document.getElementById('analyse-foto').click()">ðŸ“· Voeg foto toe</button>
  <input type="file" accept="image/*" id="analyse-foto">
  <img id="analyse-preview" style="display:none;">
  <textarea id="analyse-uitleg" placeholder="Uitleg bij de foto van de analyse..." rows="3"></textarea>
</div>

<div id="photos-container"></div>

<button id="add-section">âž• Voeg een nieuwe sectie toe</button>
<br><br>
<button id="generate">ðŸ“„ Genereer PDF</button>

<img id="logo" src="IMG_1971.png" style="display: none;" />

<script>
  const { jsPDF } = window.jspdf;
  let photoCount = 0;

  document.getElementById("analyse-foto").addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById("analyse-preview");
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  function createPhotoSection(index) {
    const section = document.createElement('div');
    section.className = 'photo-section';

    const label = document.createElement('label');
    label.textContent = `Foto ${index + 1}:`;
    section.appendChild(label);

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.id = `file-${index}`;
    fileInput.style.display = 'none';

    const preview = document.createElement('img');
    preview.id = `preview-${index}`;
    preview.style.display = 'none';

    const uitleg = document.createElement('textarea');
    uitleg.placeholder = 'Uitleg bij deze foto';
    uitleg.id = `uitleg-${index}`;
    uitleg.rows = 3;

    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = 'ðŸ“· Voeg foto toe';
    button.className = 'btn-add-photo';
    button.onclick = () => fileInput.click();

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    };

    section.appendChild(button);
    section.appendChild(fileInput);
    section.appendChild(uitleg);
    section.appendChild(preview);
    return section;
  }

  function addTwoSections() {
    for (let i = 0; i < 2; i++) {
      const container = document.getElementById('photos-container');
      const section = createPhotoSection(photoCount);
      container.appendChild(section);
      photoCount++;
    }
  }

  addTwoSections();
  document.getElementById('add-section').onclick = addTwoSections;

  document.getElementById('generate').onclick = async () => {
    const pdf = new jsPDF();
    const pageWidth = pdf.internal.pageSize.getWidth();

    const logo = document.getElementById('logo');
    let logoData = null;
    if (logo.complete && logo.naturalWidth > 0) {
      const canvas = document.createElement('canvas');
      canvas.width = logo.naturalWidth;
      canvas.height = logo.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(logo, 0, 0);
      logoData = canvas.toDataURL('image/png');
    }

    let y = 40;

    function addHeader() {
      pdf.setFillColor('#42B0E5');
      pdf.rect(0, 0, pageWidth, 25, 'F');
      pdf.setTextColor(255);
      pdf.setFontSize(14);
      pdf.text("DOA-DIAGNOSTICS DIAGNOSE VERSLAG", pageWidth / 2, 17, { align: "center" });
      if (logoData) {
        pdf.addImage(logoData, 'PNG', pageWidth - 35, 3, 30, 20);
      }
    }

    function addPageIfNeeded(extraHeight = 20) {
      if (y + extraHeight > 270) {
        pdf.addPage();
        addHeader();
        y = 40;
      }
    }

    addHeader();

    const addText = (label, value) => {
      addPageIfNeeded(10);
      pdf.setTextColor(0);
      pdf.setFontSize(12);
      pdf.text(`${label}: ${value}`, 10, y);
      y += 10;
    };

    const addMultilineText = (label, text) => {
      const lines = pdf.splitTextToSize(`${label}: ${text}`, 180);
      addPageIfNeeded(lines.length * 10);
      pdf.text(lines, 10, y);
      y += lines.length * 10;
    };

    addText("Opdrachtgever", document.getElementById('klant').value);
    addText("Datum", document.getElementById('datum').value);
    addText("Kenteken", document.getElementById('kenteken').value);
    addText("Merk / Type", document.getElementById('merk').value);
    addText("VIN", document.getElementById('vin').value);
    addText("Kilometerstand", document.getElementById('kmstand').value);
    addMultilineText("Klachtomschrijving", document.getElementById('klacht').value);
    addMultilineText("Analyse van de permanent fouten", document.getElementById('fouten').value);
    addMultilineText("Diagnose en Analyse", document.getElementById('diagnose').value);

    async function addImageWithText(imgElement, uitlegText, fotonaam) {
      if (imgElement.src && imgElement.style.display !== "none") {
        const uitlegLines = pdf.splitTextToSize(`${fotonaam}: ${uitlegText}`, 180);
        addPageIfNeeded(uitlegLines.length * 10 + 80);
        pdf.text(uitlegLines, 10, y);
        y += uitlegLines.length * 10;

        const canvas = document.createElement('canvas');
        canvas.width = imgElement.naturalWidth;
        canvas.height = imgElement.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imgElement, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg');

        const maxWidth = 180;
        const scale = maxWidth / imgElement.naturalWidth;
        const imgHeight = imgElement.naturalHeight * scale;
        pdf.addImage(dataUrl, 'JPEG', 10, y, maxWidth, imgHeight);
        y += imgHeight + 10;
      }
    }

    await addImageWithText(
      document.getElementById("analyse-preview"),
      document.getElementById("analyse-uitleg").value,
      "Foto Analyse"
    );

    for (let i = 0; i < photoCount; i++) {
      await addImageWithText(
        document.getElementById(`preview-${i}`),
        document.getElementById(`uitleg-${i}`).value,
        `Foto ${i + 1}`
      );
    }

    pdf.save("diagnoseverslag.pdf");
  };
</script>
</body>
</html>