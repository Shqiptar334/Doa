<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>DOA-Diagnostics Diagnose Verslag</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 0;
    }

    header {
      background: #42b0e5;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header img {
      height: 50px;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #42b0e5;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #333;
    }

    input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .foto-sectie {
      border: 2px dashed #42b0e5;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      background: #fafcfe;
    }

    .foto-sectie textarea {
      font-weight: bold;
      font-size: 15px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
      margin-right: 10px;
    }

    #voegSectieToe {
      background: #28a745;
      color: white;
    }

    #genereerPdf {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>

<header>
  <div>DOA-DIAGNOSTICS DIAGNOSE VERSLAG</div>
  <img src="IMG_1971.png" alt="Logo">
</header>

<div class="container">
  <form id="diagnoseForm">
    <h2>Gegevens</h2>
    <div class="form-group"><label>Opdrachtgever</label><input type="text" name="opdrachtgever" required></div>
    <div class="form-group"><label>Datum</label><input type="date" name="datum" required></div>
    <div class="form-group"><label>Kenteken</label><input type="text" name="kenteken" required></div>
    <div class="form-group"><label>Merk / Type</label><input type="text" name="merk" required></div>
    <div class="form-group"><label>Bouwjaar</label><input type="text" name="bouwjaar" required></div>
    <div class="form-group"><label>VIN</label><input type="text" name="vin" required></div>
    <div class="form-group"><label>Motorcode</label><input type="text" name="motorcode" required></div>
    <div class="form-group"><label>Kilometerstand</label><input type="text" name="kilometerstand" required></div>
    <div class="form-group"><label>Klachtomschrijving</label><textarea name="klachtomschrijving" required></textarea></div>
    <div class="form-group"><label>Diagnose</label><textarea name="diagnose" required></textarea></div>
    <div class="form-group"><label>Verklaring van opdrachtgever</label><textarea name="verklaring" required></textarea></div>

    <h2>Analyse van de permanente fouten</h2>
    <div class="foto-sectie">
      <input type="file" accept="image/*" class="permanenteFoto">
      <textarea placeholder="Uitleg bij deze foto" class="permanenteUitleg"></textarea>
    </div>

    <h2>Foto's</h2>
    <div id="fotoSecties">
      <div class="foto-sectie">
        <input type="file" accept="image/*">
        <textarea placeholder="Uitleg bij foto"></textarea>
      </div>
    </div>

    <button type="button" id="voegSectieToe">Voeg een nieuwe sectie toe</button>
    <button type="button" id="genereerPdf">Genereer PDF</button>
  </form>
</div>

<script>
document.getElementById('voegSectieToe').addEventListener('click', () => {
  const container = document.getElementById('fotoSecties');
  const div = document.createElement('div');
  div.className = 'foto-sectie';
  div.innerHTML = `
    <input type="file" accept="image/*">
    <textarea placeholder="Uitleg bij foto"></textarea>
  `;
  container.appendChild(div);
});

let logoBase64 = '';
fetch('IMG_1971.png')
  .then(res => res.blob())
  .then(blob => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => { logoBase64 = reader.result; resolve(); };
    reader.readAsDataURL(blob);
  }));

document.getElementById('genereerPdf').addEventListener('click', async () => {
  const form = document.getElementById('diagnoseForm');
  const data = new FormData(form);
  const content = [];

  const velden = [
    ['Opdrachtgever', data.get('opdrachtgever')],
    ['Datum', data.get('datum')],
    ['Kenteken', data.get('kenteken')],
    ['Merk / Type', data.get('merk')],
    ['Bouwjaar', data.get('bouwjaar')],
    ['VIN', data.get('vin')],
    ['Motorcode', data.get('motorcode')],
    ['Kilometerstand', data.get('kilometerstand')],
    ['Klachtomschrijving', data.get('klachtomschrijving')],
    ['Diagnose', data.get('diagnose')],
    ['Verklaring van opdrachtgever', data.get('verklaring')]
  ];

  velden.forEach(([label, value]) => {
    content.push({
      table: {
        widths: ['30%', '*'],
        body: [[
          { text: label + ':', bold: true },
          { text: value || '' }
        ]]
      },
      margin: [0, 5, 0, 10],
      layout: 'lightHorizontalLines'
    });
  });

  // Permanente fout
  const permUitleg = document.querySelector('.permanenteUitleg').value.trim();
  const permFotoFile = document.querySelector('.permanenteFoto').files[0];

  if (permUitleg || permFotoFile) {
    const blok = [];
    blok.push({ text: 'Analyse van de permanente fouten:', bold: true, fontSize: 14, margin: [0, 10, 0, 8] });
    if (permUitleg) blok.push({ text: permUitleg, fontSize: 13, bold: true });

    if (permFotoFile) {
      const img = await toDataURL(permFotoFile);
      blok.push({ image: img, width: 300 });
    }

    content.push({ stack: blok, margin: [0, 10, 0, 10], unbreakable: true });
  }

  // Andere foto-secties
  const secties = document.querySelectorAll('#fotoSecties .foto-sectie');
  for (const sectie of secties) {
    const uitleg = sectie.querySelector('textarea').value.trim();
    const bestand = sectie.querySelector('input').files[0];
    if (!uitleg && !bestand) continue;

    const blok = [];
    if (uitleg) blok.push({ text: uitleg, fontSize: 13, bold: true });

    if (bestand) {
      const img = await toDataURL(bestand);
      blok.push({ image: img, width: 300 });
    }

    content.push({ stack: blok, margin: [0, 10, 0, 10], unbreakable: true });
  }

  header: function(currentPage, pageCount, pageSize) {
    return {
        margin: [0, 0, 0, 0],
        table: {
            widths: ['*', 'auto'],
            body: [[
                {
                    text: 'DOA-DIAGNOSTICS DIAGNOSE VERSLAG',
                    fontSize: 14,
                    bold: true,
                    color: 'white',
                    margin: [20, 10, 0, 10]
                },
                {
                    image: logoBase64 || '',
                    width: 50,
                    alignment: 'right',
                    margin: [0, 5, 20, 5]
                }
            ]]
        },
        layout: {
            fillColor: function(rowIndex, node, columnIndex) {
                return '#42b0e5';
            },
            hLineWidth: () => 0,
            vLineWidth: () => 0
        }
    };
},

  if (window.innerWidth <= 768) {
    pdfMake.createPdf(docDefinition).open();
  } else {
    pdfMake.createPdf(docDefinition).download('DOA_Diagnose_Verslag.pdf');
  }
});

function toDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
</script>

</body>
</html>